# üõ∞Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (DEEP Analysis)
# GPS Tracker System ‚Äî ESP32 + Web + Mobile

> **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:** 21 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569  
> **‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:** Principal IT Auditor + Solutions Architect  
> **‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:** 1.0  
> **‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö:** Confidential  

---

## ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (Assumptions)

| # | ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô | ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• |
|---|----------|--------|
| A1 | Server VPS IP: `143.14.200.117` | ‡∏û‡∏ö hardcode ‡πÉ‡∏ô‡∏ó‡∏±‡πâ‡∏á ESP32 firmware ‡πÅ‡∏•‡∏∞ frontend |
| A2 | Protocol: HTTP (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HTTPS) | ESP32 ‡πÉ‡∏ä‡πâ `http://` ‡πÉ‡∏ô AT command, Nginx listen port 80 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô |
| A3 | Database: SQLite (`tracker.db`) | ‡∏û‡∏ö‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î `server.js` |
| A4 | Backend: Node.js + Express + Next.js 16 | ‡∏ï‡∏≤‡∏° `package.json` |
| A5 | Mobile App: Capacitor WebView ‚Üí APK | ‡∏ï‡∏≤‡∏° `capacitor.config.json` (appId: `com.gpstracker.app`) |
| A6 | Auth: TOTP (speakeasy) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Super Admin, Phone number ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User | ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î `server.js` |
| A7 | Connectivity: ESP32 + SIM A7670C (4G LTE) | ‡∏û‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå `.ino` |
| A8 | ‡πÑ‡∏°‡πà‡∏°‡∏µ AI Agent ‡∏ó‡∏µ‡πà integrate ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô | ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á |

## ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Questions to Confirm)

1. ‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ä‡πâ IP ‡∏ï‡∏£‡∏á) ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
2. SSL/TLS Certificate ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ)
3. Data retention policy ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? ‡πÄ‡∏Å‡πá‡∏ö logs ‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?
4. Compliance requirements (PDPA, ISO27001 ‡∏Ø‡∏•‡∏Ø) ‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
5. AI Agents ‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ / ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?
6. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏à‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (10/100/1000+ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)?
7. Push Notification (FCM/APNs) ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
8. Budget ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö infrastructure upgrade ‡∏°‡∏µ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?

---

# A) Executive Summary (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chairman ‚Äî ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ)

## ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?
‡∏£‡∏∞‡∏ö‡∏ö GPS Tracker ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠ **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢** ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ESP32 + ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö 3 ‡∏ï‡∏±‡∏ß:
- **GPS** ‚Äî ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ
- **ADXL345 (Accelerometer)** ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô/‡πÄ‡∏≠‡∏µ‡∏¢‡∏á/‡∏ä‡∏ô
- **BLE (Bluetooth)** ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏ç‡πÅ‡∏à/‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ

‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢, ‡∏ä‡∏ô, ‡∏£‡∏ñ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ **‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô Server ‡∏ú‡πà‡∏≤‡∏ô 4G** ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß **‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö/‡πÅ‡∏≠‡∏õ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠** ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á

| ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î |
|-----------|-----------|
| ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå | ESP32 + SIM A7670C (4G LTE) |
| Server | VPS IP `143.14.200.117` (Node.js + SQLite) |
| Web Admin | ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏ó‡∏µ‡πà `/ctrl-x7k9` |
| Web User/APK | Next.js + Capacitor ‚Üí Android APK |
| Real-time | Socket.IO (WebSocket) |

## ‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Top 5

| # | ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á | ‡∏£‡∏∞‡∏î‡∏±‡∏ö | ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö |
|---|-----------|------|---------|
| 1 | **‡πÑ‡∏°‡πà‡∏°‡∏µ HTTPS/TLS** ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡∏ñ, ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Plain Text | üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï | ‡∏ñ‡∏π‡∏Å‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ |
| 2 | **‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Plain Text** ‚Äî ‡πÑ‡∏°‡πà Hash | üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï | ‡∏´‡∏≤‡∏Å DB ‡∏£‡∏±‡πà‡∏ß ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î |
| 3 | **Admin API ‡πÑ‡∏°‡πà‡∏°‡∏µ Auth Middleware** ‚Äî ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ | üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï | ‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏•‡∏ö Admin, ‡∏≠‡∏≠‡∏Å Credential ‡πÑ‡∏î‡πâ |
| 4 | **SQLite ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Production** ‚Äî ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö concurrent, ‡πÑ‡∏°‡πà‡∏°‡∏µ replication | üü† ‡∏™‡∏π‡∏á | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢, ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô |
| 5 | **Google Maps API Key ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡πÉ‡∏ô Frontend** ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ restriction | üü† ‡∏™‡∏π‡∏á | ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á |

## üéØ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥ (Prioritized)

| ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ | ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ | ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö |
|----------|-------------|-------------|
| **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô** | ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á SSL/TLS (Let's Encrypt) ‡∏ö‡∏ô Nginx | DevOps |
| **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô** | Hash password ‡∏î‡πâ‡∏ß‡∏¢ bcrypt ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ | Backend |
| **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 14 ‡∏ß‡∏±‡∏ô** | ‡πÄ‡∏û‡∏¥‡πà‡∏° Auth Middleware ‡∏ö‡∏ô Admin API ‡∏ó‡∏∏‡∏Å‡πÄ‡∏™‡πâ‡∏ô | Backend |
| **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô** | Restrict Google Maps API Key | Frontend/DevOps |
| **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 60 ‡∏ß‡∏±‡∏ô** | Migrate SQLite ‚Üí PostgreSQL | Backend/DevOps |
| **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 90 ‡∏ß‡∏±‡∏ô** | ‡πÄ‡∏û‡∏¥‡πà‡∏° Rate Limiting, Input Validation, Audit Logs | Security/Backend |

---

# B) System Architecture Map

## ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)

‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å:

1. **Device Layer** ‚Äî ESP32 + ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå (GPS, ADXL345, BLE) + ‡πÇ‡∏°‡πÄ‡∏î‡πá‡∏° SIM A7670C
2. **Network Layer** ‚Äî 4G LTE cellular (AIS/DTAC/TRUE) ‚Üí Internet ‚Üí VPS
3. **Backend Layer** ‚Äî Node.js/Express server + SQLite DB + Socket.IO
4. **Frontend Layer** ‚Äî Next.js SSR + Client-side React
5. **Client Layer** ‚Äî Web Browser (Admin) + Capacitor APK (User)

## ASCII Architecture Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        DEVICE LAYER (ESP32)                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   GPS    ‚îÇ  ‚îÇ ADXL345  ‚îÇ  ‚îÇ   BLE    ‚îÇ  ‚îÇ     Buzzer       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Module   ‚îÇ  ‚îÇ Accel.   ‚îÇ  ‚îÇ Scanner  ‚îÇ  ‚îÇ   + LED          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                  ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                   ‚îÇ
‚îÇ              ‚îÇ   ESP32 MCU      ‚îÇ                                   ‚îÇ
‚îÇ              ‚îÇ   (State Machine)‚îÇ                                   ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                   ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                   ‚îÇ
‚îÇ              ‚îÇ   SIM A7670C     ‚îÇ                                   ‚îÇ
‚îÇ              ‚îÇ   (4G LTE)       ‚îÇ                                   ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ HTTP POST (text/plain)
                       ‚îÇ http://143.14.200.117/api/track
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     NETWORK LAYER                                    ‚îÇ
‚îÇ   4G LTE (Cellular) ‚îÄ‚îÄ‚ñ∫ Internet ‚îÄ‚îÄ‚ñ∫ VPS (143.14.200.117)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ Port 80
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     VPS (143.14.200.117)                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ     Nginx       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  Node.js Server (PM2)                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   (Port 80)     ‚îÇ     ‚îÇ  Express + Next.js (Port 3000)       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   Reverse Proxy ‚îÇ     ‚îÇ                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ Socket.IO  ‚îÇ  ‚îÇ   REST API    ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ (WebSocket)‚îÇ  ‚îÇ  /api/*       ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ        ‚îÇ                  ‚îÇ           ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ         SQLite (tracker.db)     ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ  Tables: devices, logs,         ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ  credentials, vehicles,         ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ  registrations, geofences,      ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îÇ  admins, settings               ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ                          ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ   ‚îÇ
‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ                    ‚îÇ
              WebSocket    ‚îÇ                    ‚îÇ  HTTPS (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
                           ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     CLIENT LAYER                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   Admin Dashboard    ‚îÇ    ‚îÇ   User App (Capacitor APK)       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   /ctrl-x7k9         ‚îÇ    ‚îÇ   / (Login) ‚Üí /map (Dashboard)  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   - Device List      ‚îÇ    ‚îÇ   - Live Map (Google Maps)       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   - Credentials      ‚îÇ    ‚îÇ   - Geofence                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   - Admin Mgmt       ‚îÇ    ‚îÇ   - History / SOS                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   - Logs             ‚îÇ    ‚îÇ   - Alert Sound                  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

# C) Data Flow ‚Äî ‡∏ó‡∏∏‡∏Å Flow ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

## Flow 1: Device Boot / Provisioning

### Trigger
ESP32 ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á (‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡πÑ‡∏ü‡∏£‡∏ñ / ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà) ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏∑‡πà‡∏ô‡∏à‡∏≤‡∏Å Deep Sleep (ADXL345 Activity Interrupt)

### Actors
Device (ESP32), SIM Module (A7670C), BLE Key Fob

### Step-by-step

| Step | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î |
|------|-----------|
| 1 | ESP32 ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‚Üí `setup()` ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô |
| 2 | ‡πÄ‡∏õ‡∏¥‡∏î Serial ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GPS (9600 baud), SIM A7670C (115200 baud) |
| 3 | ‡πÄ‡∏õ‡∏¥‡∏î I2C ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ADXL345 (SDA=7, SCL=9) |
| 4 | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ADXL345: Range 16G, Activity Detection, AC Mode |
| 5 | ‡πÄ‡∏õ‡∏¥‡∏î GPIO pins: Enable (GPS), LED, Buzzer |
| 6 | Init BLE Scanner ‚Üí ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤ Key Fob (`ff:ff:50:00:20:73` ‡∏´‡∏£‡∏∑‡∏≠ `28:9b:a2:70:48:7e`) |
| 7 | ‡∏™‡∏£‡πâ‡∏≤‡∏á FreeRTOS Task ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö BLE Scanner ‡∏ö‡∏ô Core 0 |
| 8 | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deep Sleep Wake-up ‡∏ú‡πà‡∏≤‡∏ô GPIO (wakeupPin = 0, HIGH level trigger) |
| 9 | ‡πÄ‡∏Ç‡πâ‡∏≤ `loop()` ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏° State Machine ‡∏´‡∏•‡∏±‡∏Å (`mainRun()`) ‡∏ó‡∏µ‡πà process = 0 |
| 10 | ‡∏£‡∏≠ BLE Key ‡∏´‡∏£‡∏∑‡∏≠ timeout 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡πÑ‡∏õ‡∏¢‡∏±‡∏á process 2 (Idle/Monitoring) |

### Data Fields
`wakeupPin`, `BLE targetAddress1/2`, `ADXL345 threshold`, `GPS enPin`

### API Endpoints
‡πÑ‡∏°‡πà‡∏°‡∏µ (Device provisioning ‡∏ó‡∏≥‡∏ö‡∏ô‡∏ï‡∏±‡∏ß ESP32 ‡πÄ‡∏≠‡∏á ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö OTA provisioning)

### Security Controls
- ‚ö†Ô∏è **‡πÑ‡∏°‡πà‡∏°‡∏µ Device Authentication** ‚Äî ESP32 ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
- ‚ö†Ô∏è **BLE Key Address hardcoded** ‚Äî ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô key ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà flash firmware ‡πÉ‡∏´‡∏°‡πà
- ‚ö†Ô∏è **‡πÑ‡∏°‡πà‡∏°‡∏µ Secure Boot / Flash Encryption**

### Failure Modes + Recovery
| Failure | Recovery |
|---------|----------|
| BLE init ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏∏‡∏ç‡πÅ‡∏à ‚Üí ‡∏≠‡∏≤‡∏à false alarm |
| ADXL345 ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö | ‡πÑ‡∏°‡πà‡∏°‡∏µ error handling ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Æ‡∏á/‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô |
| GPS ‡πÑ‡∏°‡πà lock | ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ lat/lng ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å RTC Memory ‚Üí ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏≤ |
| SIM A7670C ‡πÑ‡∏°‡πà register | Retry loop ‡∏î‡πâ‡∏ß‡∏¢ AT+CREG? ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡∏à‡∏ô register ‡πÑ‡∏î‡πâ |

---

## Flow 2: Tracking ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Interval)

### Trigger
ADXL345 ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô (magnitude ‚â• 0.5 m/s¬≤) + BLE Key ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Driving Mode

### Actors
Device (ESP32), Server, Admin/User Frontend

### Step-by-step

| Step | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î |
|------|-----------|
| 1 | ADXL345 ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å 100ms ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì magnitude = ‚àö(x¬≤+y¬≤+z¬≤) - 9.81 |
| 2 | magnitude ‚â• 0.5 ‚Üí GPS Module ‡πÄ‡∏õ‡∏¥‡∏î (enPin HIGH) |
| 3 | GPS ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ NMEA ‚Üí TinyGPSPlus parse ‚Üí ‡πÑ‡∏î‡πâ lat, lng, timestamp |
| 4 | GPS ‡πÑ‡∏î‡πâ fix ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô RTC Memory (‡∏£‡∏≠‡∏î‡∏à‡∏≤‡∏Å Deep Sleep) |
| 5 | BLE scan ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Key (avgRSSI > -100 dBm) |
| 6 | BLE Key ‡∏≠‡∏¢‡∏π‡πà + ‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô ‚Üí `mainFunc::process = 5` (Driving Mode) |
| 7 | ‡∏™‡πà‡∏á status type 3 (NORMAL) ‡∏î‡πâ‡∏ß‡∏¢ `sentToServer()` |
| 8 | A7670C ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á HTTP: HTTPTERM ‚Üí HTTPINIT ‚Üí SSL Config ‚Üí URL ‚Üí CONTENT |
| 9 | ‡∏™‡∏£‡πâ‡∏≤‡∏á payload: `"MAC,3 LAT, LNG, TIMESTAMP"` (text/plain) |
| 10 | HTTP POST ‡πÑ‡∏õ‡∏ó‡∏µ‡πà `http://143.14.200.117/api/track` |
| 11 | Server ‡∏£‡∏±‡∏ö ‚Üí parse text ‚Üí insert `logs` table + upsert `devices` table |
| 12 | Server ‡∏ï‡∏£‡∏ß‡∏à Geofence (Haversine formula) ‚Üí emit alert ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ |
| 13 | Server emit `device_update` ‡∏ú‡πà‡∏≤‡∏ô Socket.IO ‚Üí **‡∏ó‡∏∏‡∏Å Client ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠** |
| 14 | Frontend ‡∏£‡∏±‡∏ö event ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï marker ‡∏ö‡∏ô Google Maps |
| 15 | GPS ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô fix ‡πÉ‡∏´‡∏°‡πà 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí GPS ‡∏õ‡∏¥‡∏î (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô) |
| 16 | GPS timeout 180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î GPS |

### Data Fields (Payload ‡∏à‡∏£‡∏¥‡∏á)
```
ff:ff:50:00:20:73,3 13.74690000, 100.53490000, 1771598000
```
| Field | ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ |
|-------|------------|----------|
| device_id (MAC) | `ff:ff:50:00:20:73` | BLE Key MAC Address (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Device ID) |
| status | `3` | 0=PARKED, 1=STOLEN, 2=CRASH, 3=NORMAL |
| lat | `13.74690000` | ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (8 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°) |
| lng | `100.53490000` | ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î |
| timestamp | `1771598000` | Unix timestamp (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) |

### API Endpoint
`POST /api/track` ‚Äî Content-Type: `text/plain`

### Security Controls
- ‚õî **‡πÑ‡∏°‡πà‡∏°‡∏µ** ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ auth, ‡πÑ‡∏°‡πà‡∏°‡∏µ HMAC, ‡πÑ‡∏°‡πà‡∏°‡∏µ encryption, ‡πÑ‡∏°‡πà‡∏°‡∏µ replay protection
- ‚ö†Ô∏è ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡∏™‡πà‡∏á spoofed GPS data ‡πÑ‡∏õ‡∏¢‡∏±‡∏á server ‡πÑ‡∏î‡πâ

### Failure Modes + Recovery
| Failure | Recovery |
|---------|----------|
| 4G ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì | A7670C retry AT+CFUN=1 ‚Üí AT+CREG? loop |
| HTTP timeout (15s) | ‡∏™‡πà‡∏á HTTPTERM ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà |
| Server ‡∏ï‡∏≠‡∏ö non-200 | ‚ö†Ô∏è **‡πÑ‡∏°‡πà‡∏°‡∏µ store-and-forward** ‚Üí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢‡πÑ‡∏õ |
| GPS jitter | ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ Kalman filter ‚Üí ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î |

---

## Flow 3: Event/Alert (STOLEN, CRASH)

### Trigger ‚Äî STOLEN (type 1)
BLE Key **‡πÑ‡∏°‡πà‡∏û‡∏ö** (timeout 6 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) + ADXL345 ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô (‚â• 2.25 m/s¬≤)

### Trigger ‚Äî CRASH (type 2)
BLE Key **‡∏≠‡∏¢‡∏π‡πà** + ‡∏Ç‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà + ADXL345 ‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏µ‡∏¢‡∏á > 75¬∞ ‡∏ô‡∏≤‡∏ô > 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

### Actors
Device (ESP32), Server, User Frontend, Buzzer/LED

### Step-by-step (STOLEN Scenario)

| Step | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î |
|------|-----------|
| 1 | BLE scan timeout 6000ms ‚Üí `bluetoothFunc::state = false` |
| 2 | ‡∏™‡πà‡∏á type 0 (BLE Disconnected/PARKED) ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + Buzzer beep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á |
| 3 | ADXL345 ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö vibration ‚â• 2.25 m/s¬≤ (‡∏£‡∏ñ‡∏™‡∏±‡πà‡∏ô/‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢) |
| 4 | `mainFunc::process = 3` ‚Üí **ALARM!** |
| 5 | Buzzer beep 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡∏±‡∏á) |
| 6 | ‡∏™‡πà‡∏á `MAC,1 LAT, LNG, TIMESTAMP` ‚Üí Server |
| 7 | Server map status `1` ‚Üí `"STOLEN"` |
| 8 | Server INSERT logs + UPDATE devices + emit `device_update` |
| 9 | Frontend ‡∏£‡∏±‡∏ö ‚Üí ‡∏ï‡∏£‡∏ß‡∏à status = STOLEN ‚Üí **‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á alert.mp3 (loop)** |
| 10 | ‡πÅ‡∏™‡∏î‡∏á Alert Popup ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏™‡∏µ‡πÅ‡∏î‡∏á) |
| 11 | ‡∏™‡πà‡∏á Browser Push Notification: "üö® ‡∏£‡∏ñ xxx ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ñ‡∏π‡∏Å‡πÇ‡∏à‡∏£‡∏Å‡∏£‡∏£‡∏°!" |
| 12 | ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí Client-side auto-safe ‚Üí NORMAL |
| 13 | ‡πÄ‡∏°‡∏∑‡πà‡∏≠ BLE Key ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‚Üí `mainFunc::process = 5` ‚Üí ‡∏Å‡∏•‡∏±‡∏ö Driving Mode |
| 14 | ‡∏™‡πà‡∏á type 3 (NORMAL) ‚Üí Server ‚Üí Frontend ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏õ‡∏¥‡∏î Popup |

### Security Controls
- ‚ö†Ô∏è **Auto-safe 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ö‡∏ô Client-side** ‚Äî ‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏≠‡∏≤‡∏à mask real alerts
- ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ SMS/call notification ‚Üí ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
- ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ escalation path ‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≥‡∏£‡∏ß‡∏à/security

---

## Flow 4: Offline / Store-and-Forward

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ

**‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á:** ‡∏£‡∏∞‡∏ö‡∏ö **‡πÑ‡∏°‡πà‡∏°‡∏µ** store-and-forward mechanism

- GPS coordinates ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô RTC Memory (‡∏£‡∏≠‡∏î‡∏à‡∏≤‡∏Å Deep Sleep) ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
- ‡∏´‡∏≤‡∏Å A7670C ‡∏™‡πà‡∏á HTTP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏°‡∏µ local buffer/queue
- ‡πÑ‡∏°‡πà‡∏°‡∏µ SPIFFS/LittleFS storage ‡∏ö‡∏ô ESP32 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á offline

### ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ

| Component | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ |
|-----------|----------|
| Circular Buffer (RAM) | ‡πÄ‡∏Å‡πá‡∏ö 50-100 records ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ |
| SPIFFS/LittleFS Queue | ‡πÄ‡∏Å‡πá‡∏ö 1000+ records ‡πÉ‡∏ô Flash |
| Retry with Backoff | ‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (2s, 4s, 8s) |
| Batch Upload | ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ online ‚Üí ‡∏™‡πà‡∏á‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß batch |
| Server Deduplication | ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô duplicate ‡∏î‡πâ‡∏ß‡∏¢ (device_id + timestamp) unique key |
